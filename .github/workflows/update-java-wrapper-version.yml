name: Update AST CLI Java Wrapper Version

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Specify a version of ast-cli-java-wrapper (leave empty for latest)"
        required: false
        type: string

jobs:
  update-ast-cli-wrapper:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4.2.1
        with:
          java-version: 11
          distribution: 'temurin'
          server-id: github
          settings-path: ${{ github.workspace }}

      - name: Install xmllint
        run: sudo apt-get install -y libxml2-utils

      - name: Build with Maven
        run: mvn -B package --file pom.xml -s $GITHUB_WORKSPACE/settings.xml -DskipTests
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Get current version from pom.xml
        id: checkmarx-ast-cli
        run: |
          # Ensure the script is running from the correct directory
          if [[ ! -f "../../pom.xml" ]]; then
            echo "❌ pom.xml not found in $(pwd)"
            exit 1
          fi

          # Extract the version using grep
          CURRENT_VERSION=$(grep -oPm1 "(?<=<groupId>com.checkmarx.ast</groupId>\s*<artifactId>ast-cli-java-wrapper</artifactId>\s*<version>)[^<]+" ../../pom.xml | tr -d '[:space:]')

          # If grep fails, use sed as a fallback
          if [[ -z "$CURRENT_VERSION" ]]; then
            CURRENT_VERSION=$(sed -n '/<groupId>com.checkmarx.ast<\/groupId>/,/<\/dependency>/p' ../../pom.xml | grep -oPm1 "(?<=<version>)[^<]+")
          fi

          # Exit if we still couldn't extract the version
          if [[ -z "$CURRENT_VERSION" ]]; then
            echo "❌ Failed to extract current version from pom.xml"
            exit 1
          fi

          echo "Current version: $CURRENT_VERSION"
          echo "current_tag=$CURRENT_VERSION" >> $GITHUB_ENV

      - name: Determine version to use
        id: determine-version
        run: |
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION=${{ github.event.inputs.version }}
            echo "Using specified version: $VERSION"
          else
            VERSION=$(curl -s "https://repo1.maven.org/maven2/com/checkmarx/ast/ast-cli-java-wrapper/maven-metadata.xml" | \
            xmllint --xpath "string(//metadata/versioning/latest/text())" -)
            if [[ -z "$VERSION" ]]; then
              echo "❌ Failed to fetch latest version from Maven repository"
              exit 1
            fi
            echo "Fetched latest version: $VERSION"
          fi
          echo "release_tag=$VERSION" >> $GITHUB_ENV

      - name: Check if update is needed
        run: |
          echo "Current version: ${{ env.current_tag }}"
          echo "Latest version: ${{ env.release_tag }}"

          if [[ "${{ env.current_tag }}" == "${{ env.release_tag }}" ]]; then
            echo "✅ Already using the latest version (${{ env.release_tag }}) in Maven."
            exit 0
          fi

      - name: Update ast-cli-java-wrapper version in pom.xml
        run: |
          sed -i "s|<groupId>com.checkmarx.ast</groupId>\n\s*<artifactId>ast-cli-java-wrapper</artifactId>\n\s*<version>.*</version>|<groupId>com.checkmarx.ast</groupId>\n        <artifactId>ast-cli-java-wrapper</artifactId>\n        <version>${{ env.release_tag }}</version>|g" ../../pom.xml

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@c5a7806660adbe173f04e3e038b0ccdcd758773c #v6
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          branch: update-ast-cli-java-wrapper
          title: "Update ast-cli-java-wrapper to version ${{ env.release_tag }}"
          body: "This PR updates the ast-cli-java-wrapper dependency in pom.xml to version ${{ env.release_tag }}."
          commit-message: "Update ast-cli-java-wrapper to version ${{ env.release_tag }}"
          delete-branch: true